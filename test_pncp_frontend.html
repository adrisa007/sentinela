<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PNCP - Diagn√≥stico</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        input { padding: 8px; width: 200px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç Teste de Integra√ß√£o PNCP</h1>
    
    <div class="section">
        <h2>1. Fazer Login</h2>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="senha123">
        <button onclick="testLogin()">Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="section">
        <h2>2. Testar PNCP</h2>
        <input type="text" id="cnpj" placeholder="CNPJ" value="12345678000190">
        <button onclick="testPNCP()">Consultar PNCP</button>
        <div id="pncpResult"></div>
    </div>

    <div class="section">
        <h2>3. Verificar LocalStorage</h2>
        <button onclick="checkStorage()">Verificar Storage</button>
        <div id="storageResult"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const api = axios.create({
            baseURL: API_URL,
            headers: {
                'Content-Type': 'application/json',
            },
        });

        // Interceptor para adicionar token
        api.interceptors.request.use((config) => {
            const token = localStorage.getItem('token');
            console.log('üîë Token encontrado:', token ? 'SIM' : 'N√ÉO');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
                console.log('üîë Authorization header:', config.headers.Authorization.substring(0, 30) + '...');
            }
            console.log('üì° Request URL:', config.url);
            console.log('üì° Full URL:', config.baseURL + config.url);
            return config;
        });

        // Interceptor para logs de resposta
        api.interceptors.response.use(
            (response) => {
                console.log('‚úÖ Response:', response.status, response.statusText);
                return response;
            },
            (error) => {
                console.error('‚ùå Error:', error.message);
                console.error('‚ùå Response:', error.response);
                return Promise.reject(error);
            }
        );

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                console.log('üîê Fazendo login...');
                const response = await api.post('/auth/login', { username, password });
                const token = response.data.access_token;
                
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(response.data.user));
                
                resultDiv.className = 'section success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Login bem-sucedido!</strong><br>
                    Token: ${token.substring(0, 50)}...<br>
                    User: ${JSON.stringify(response.data.user, null, 2)}
                `;
            } catch (error) {
                resultDiv.className = 'section error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Erro no login</strong><br>
                    ${error.response?.data?.detail || error.message}
                `;
            }
        }

        async function testPNCP() {
            const cnpj = document.getElementById('cnpj').value;
            const resultDiv = document.getElementById('pncpResult');
            
            try {
                console.log('üîç Consultando PNCP para CNPJ:', cnpj);
                const response = await api.get(`/pncp/fornecedor/${cnpj}`);
                
                resultDiv.className = 'section success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Consulta PNCP bem-sucedida!</strong><br>
                    <pre>${JSON.stringify(response.data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.className = 'section error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Erro na consulta PNCP</strong><br>
                    Mensagem: ${error.message}<br>
                    Status: ${error.response?.status || 'N/A'}<br>
                    Detalhes: ${error.response?.data?.detail || 'N/A'}<br>
                    <pre>${JSON.stringify(error.response?.data || error, null, 2)}</pre>
                `;
            }
        }

        function checkStorage() {
            const resultDiv = document.getElementById('storageResult');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            resultDiv.className = 'section';
            resultDiv.innerHTML = `
                <strong>üì¶ LocalStorage:</strong><br>
                Token: ${token ? token.substring(0, 50) + '...' : '‚ùå N√ÉO ENCONTRADO'}<br>
                User: ${user ? '<pre>' + JSON.stringify(JSON.parse(user), null, 2) + '</pre>' : '‚ùå N√ÉO ENCONTRADO'}
            `;
        }

        // Verificar storage ao carregar
        window.onload = checkStorage;
    </script>
</body>
</html>
